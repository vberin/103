<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ - 103med.taxi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f4f8; }
        .calculator-container { max-width: 800px; margin: 2rem auto; background: white; border-radius: 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .form-step { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background-color: #e2e8f0; color: #4a5568; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 1rem; flex-shrink: 0; }
        .step-active .step-circle { background-color: #06b6d4; color: white; }
        .step-title { font-size: 1.25rem; font-weight: 800; color: #2d3748; }
        #map { height: 300px; width: 100%; border-radius: 0.5rem; margin-top: 1rem; }
        
        /* Loading Overlay */
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(2px); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #06b6d4; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Radio Styling */
        input[type="radio"]:checked + label { background-color: #e0f2fe; border-color: #06b6d4; color: #0e7490; ring: 2px; ring-color: #06b6d4; }
        .transition-all { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body>

<div class="calculator-container relative">
    <div id="loading" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner mx-auto mb-2"></div>
            <p class="font-semibold text-gray-600">–ë—É–¥—É—î–º–æ –º–∞—Ä—à—Ä—É—Ç...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
        <a href="index.html" class="flex items-center gap-2 text-gray-700 hover:text-cyan-600 font-bold transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            –ù–∞ –≥–æ–ª–æ–≤–Ω—É
        </a>
        <div class="text-xl font-black text-gray-800">103med<span class="text-cyan-500">.taxi</span></div>
    </div>

    <form id="calcForm">
        
        <!-- –ö–†–û–ö 1: –ú–ê–†–®–†–£–¢ -->
        <div class="form-step step-active">
            <div class="flex items-center mb-4">
                <div class="step-circle">1</div>
                <h2 class="step-title">–ú–∞—Ä—à—Ä—É—Ç –ø–æ—ó–∑–¥–∫–∏</h2>
            </div>
            
            <div class="space-y-4">
                <div class="relative">
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">–¢–æ—á–∫–∞ –ê (–ó–≤—ñ–¥–∫–∏)</label>
                    <div class="relative">
                        <input type="text" id="from" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –ø–æ–¥–∞—á—ñ" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-cyan-500 outline-none transition-all" required>
                        <button type="button" id="geolocateBtn" class="absolute right-3 top-3 text-gray-400 hover:text-cyan-600" title="–í–∏–∑–Ω–∞—á–∏—Ç–∏ –º–æ—é –∞–¥—Ä–µ—Å—É">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="waypoints-list" class="space-y-3"></div>

                <div class="relative">
                     <label class="text-xs font-bold text-gray-500 uppercase ml-1">–¢–æ—á–∫–∞ –ë (–ö—É–¥–∏)</label>
                    <input type="text" id="to" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫—ñ–Ω—Ü–µ–≤—É –∞–¥—Ä–µ—Å—É" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-cyan-500 outline-none transition-all" required>
                </div>

                <div class="flex justify-between items-center pt-2">
                    <button type="button" id="addWaypointBtn" class="text-sm font-bold text-cyan-600 hover:text-cyan-800 flex items-center bg-cyan-50 px-3 py-2 rounded-lg transition hover:bg-cyan-100">
                        <span class="text-xl mr-1 font-bold">+</span> –î–æ–¥–∞—Ç–∏ –∑–∞—ó–∑–¥
                    </button>
                </div>

                <div id="map" class="hidden shadow-inner bg-gray-100 border border-gray-200"></div>
                <div id="route-stats" class="hidden bg-blue-50 p-3 rounded-lg text-center text-blue-800 font-semibold text-sm mt-2 border border-blue-100"></div>
            </div>
        </div>

        <!-- –ö–†–û–ö 2: –ß–ê–° –¢–ê –î–ê–¢–ê -->
        <div class="form-step bg-gray-50">
            <div class="flex items-center mb-4">
                <div class="step-circle">2</div>
                <h2 class="step-title">–ö–æ–ª–∏ —ó–¥–µ–º–æ?</h2>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="w-full sm:w-1/2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">–î–∞—Ç–∞</label>
                    <input type="date" id="trip-date" class="w-full p-3 border rounded-lg bg-white focus:border-cyan-500 outline-none" required>
                </div>
                <div class="w-full sm:w-1/2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">–ß–∞—Å –ø–æ–¥–∞—á—ñ</label>
                    <input type="time" id="trip-time" class="w-full p-3 border rounded-lg bg-white focus:border-cyan-500 outline-none" required>
                </div>
                <button type="button" id="nowBtn" class="w-full sm:w-auto px-4 py-3 bg-cyan-100 text-cyan-700 font-bold rounded-lg hover:bg-cyan-200 transition mb-[1px]">
                    –ù–∞ –∑–∞—Ä–∞–∑ (+30 —Ö–≤)
                </button>
            </div>
        </div>

        <!-- –ö–†–û–ö 3: –ü–ê–¶–Ü–Ñ–ù–¢ -->
        <div class="form-step">
            <div class="flex items-center mb-4">
                <div class="step-circle">3</div>
                <h2 class="step-title">–ü—Ä–æ –ø–∞—Ü—ñ—î–Ω—Ç–∞</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- –î—ñ–∞–≥–Ω–æ–∑ -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">–û—Å–Ω–æ–≤–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ / –î—ñ–∞–≥–Ω–æ–∑</label>
                    <select id="diagnosis" class="w-full p-3 border rounded-lg bg-white focus:border-cyan-500 outline-none">
                       <option>–û–±–º–µ–∂–µ–Ω–∞ —Ä—É—Ö–ª–∏–≤—ñ—Å—Ç—å (–≤—ñ–∫)</option>
                       <option>–ü—ñ—Å–ª—è —ñ–Ω—Å—É–ª—å—Ç—É</option>
                       <option>–ü–µ—Ä–µ–ª–æ–º (—Å—Ç–µ–≥–Ω–∞, —Ö—Ä–µ–±—Ç–∞)</option>
                       <option>–ü—ñ—Å–ª—è –æ–ø–µ—Ä–∞—Ü—ñ—ó</option>
                       <option>–û–Ω–∫–æ–ª–æ–≥—ñ—è</option>
                       <option>–ü–ª–∞–Ω–æ–≤–∞ –≥–æ—Å–ø—ñ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è</option>
                       <option>–Ü–Ω—à–µ</option>
                    </select>
                </div>
                
                <!-- –í–∞–≥–∞ -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">–í–∞–≥–∞ –ø–∞—Ü—ñ—î–Ω—Ç–∞</label>
                    <select id="weight" class="w-full p-3 border rounded-lg bg-white focus:border-cyan-500 outline-none">
                        <option value="90">–î–æ 90 –∫–≥ (2 —Å–∞–Ω—ñ—Ç–∞—Ä–∏)</option>
                        <option value="120">90 - 120 –∫–≥ (3 —Å–∞–Ω—ñ—Ç–∞—Ä–∏)</option>
                        <option value="130">120+ –∫–≥ (4 —Å–∞–Ω—ñ—Ç–∞—Ä–∏)</option>
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">–°—Ç–∞–Ω (–¥–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É–≤–∞–Ω–Ω—è)</label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <input type="radio" name="condition" id="cond-sit" value="sit" class="hidden">
                        <label for="cond-sit" class="block text-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            ü™ë –ú–æ–∂–µ —Å–∏–¥—ñ—Ç–∏
                        </label>
                    </div>
                    <div>
                        <input type="radio" name="condition" id="cond-lie" value="lie" class="hidden" checked>
                        <label for="cond-lie" class="block text-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            üõèÔ∏è –¢—ñ–ª—å–∫–∏ –ª–µ–∂–∞—á–∏
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–†–û–ö 4: –£–ú–û–í–ò (–ü–æ–≤–µ—Ä—Ö–∏) -->
        <div class="form-step bg-gray-50">
            <div class="flex items-center mb-4">
                <div class="step-circle">4</div>
                <h2 class="step-title">–î–µ—Ç–∞–ª—ñ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- –¢–æ—á–∫–∞ –ê -->
                <div class="bg-white p-4 rounded-xl border shadow-sm">
                    <p class="font-bold text-gray-800 mb-3 border-b pb-2">üìç –ó–≤—ñ–¥–∫–∏ –∑–∞–±–∏—Ä–∞—î–º–æ?</p>
                    <div class="space-y-2">
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div>
                                <input type="radio" name="fromType" id="f-hosp" value="hospital" class="hidden" checked>
                                <label for="f-hosp" class="block p-2 border rounded text-center cursor-pointer">–õ—ñ–∫–∞—Ä–Ω—è</label>
                            </div>
                            <div>
                                <input type="radio" name="fromType" id="f-home" value="home" class="hidden">
                                <label for="f-home" class="block p-2 border rounded text-center cursor-pointer">–î—ñ–º</label>
                            </div>
                            <div>
                                <input type="radio" name="fromType" id="f-other" value="pansionat" class="hidden">
                                <label for="f-other" class="block p-2 border rounded text-center cursor-pointer">–Ü–Ω—à–µ</label>
                            </div>
                        </div>
                        
                        <div id="from-floor-opts" class="hidden mt-3 pt-2 border-t border-dashed">
                            <label class="text-xs font-bold text-gray-500 uppercase">–ü–æ–≤–µ—Ä—Ö (—Å–ø—É—Å–∫)</label>
                            <div class="flex gap-2 mt-1">
                                <select id="from-floor" class="w-20 p-2 border rounded text-sm bg-gray-50"></select>
                                <label class="flex items-center text-sm p-2 border rounded flex-grow cursor-pointer bg-gray-50">
                                    <input type="checkbox" id="from-elevator" class="mr-2 h-4 w-4 text-cyan-600">
                                    –Ñ –≤–∞–Ω—Ç–∞–∂–Ω–∏–π –ª—ñ—Ñ—Ç
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –¢–æ—á–∫–∞ –ë -->
                <div class="bg-white p-4 rounded-xl border shadow-sm">
                    <p class="font-bold text-gray-800 mb-3 border-b pb-2">üèÅ –ö—É–¥–∏ –¥–æ—Å—Ç–∞–≤–ª—è—î–º–æ?</p>
                    <div class="space-y-2">
                         <div class="grid grid-cols-3 gap-2 text-sm">
                            <div>
                                <input type="radio" name="toType" id="t-hosp" value="hospital" class="hidden" checked>
                                <label for="t-hosp" class="block p-2 border rounded text-center cursor-pointer">–õ—ñ–∫–∞—Ä–Ω—è</label>
                            </div>
                            <div>
                                <input type="radio" name="toType" id="t-home" value="home" class="hidden">
                                <label for="t-home" class="block p-2 border rounded text-center cursor-pointer">–î—ñ–º</label>
                            </div>
                            <div>
                                <input type="radio" name="toType" id="t-other" value="pansionat" class="hidden">
                                <label for="t-other" class="block p-2 border rounded text-center cursor-pointer">–Ü–Ω—à–µ</label>
                            </div>
                        </div>
                        
                        <div id="to-floor-opts" class="hidden mt-3 pt-2 border-t border-dashed">
                            <label class="text-xs font-bold text-gray-500 uppercase">–ü–æ–≤–µ—Ä—Ö (–ø—ñ–¥–π–æ–º)</label>
                            <div class="flex gap-2 mt-1">
                                <select id="to-floor" class="w-20 p-2 border rounded text-sm bg-gray-50"></select>
                                <label class="flex items-center text-sm p-2 border rounded flex-grow cursor-pointer bg-gray-50">
                                    <input type="checkbox" id="to-elevator" class="mr-2 h-4 w-4 text-cyan-600">
                                    –Ñ –≤–∞–Ω—Ç–∞–∂–Ω–∏–π –ª—ñ—Ñ—Ç
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—á—ñ–∫—É–≤–∞–Ω–Ω—è -->
            <div class="mt-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">–ß–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (–ø–æ–∫–∏ –ø—Ä–æ–π–¥–µ—Ç–µ –æ–±—Å—Ç–µ–∂–µ–Ω–Ω—è)?</label>
                <select id="waiting" class="w-full p-3 border rounded-lg bg-white focus:border-cyan-500 outline-none">
                    <option value="0">–ù—ñ, —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è</option>
                    <option value="30">30 —Ö–≤ (+250 –≥—Ä–Ω)</option>
                    <option value="60">1 –≥–æ–¥–∏–Ω–∞ (+500 –≥—Ä–Ω)</option>
                    <option value="120">2 –≥–æ–¥–∏–Ω–∏ (+1000 –≥—Ä–Ω)</option>
                </select>
            </div>
        </div>

        <!-- –ö–†–û–ö 5: –ü–Ü–î–°–£–ú–û–ö -->
        <div class="bg-gray-900 text-white p-6 md:p-8">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-bold text-gray-400 mb-1">–í–∞—à–µ —ñ–º'—è</label>
                    <input type="text" id="name" placeholder="–Ü–≤–∞–Ω" class="w-full p-3 rounded-lg text-gray-900 border-2 border-transparent focus:border-cyan-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-400 mb-1">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É <span class="text-red-500">*</span></label>
                    <input type="tel" id="phone" placeholder="+38 (0XX) XXX-XX-XX" class="w-full p-3 rounded-lg text-gray-900 border-2 border-transparent focus:border-cyan-500 outline-none" required>
                </div>
            </div>

            <div id="summary-content" class="space-y-2 text-sm text-gray-300 border-t border-gray-700 pt-4 mb-6">
                <p class="italic text-gray-500">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤–∏—â–µ, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ.</p>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-end border-t border-gray-700 pt-6">
                <div class="mb-4 md:mb-0">
                    <p class="text-gray-400 text-sm uppercase tracking-wider">–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å:</p>
                    <p class="text-5xl font-extrabold text-cyan-400 leading-none mt-1" id="total-price">0 <span class="text-2xl font-normal text-white">–≥—Ä–Ω</span></p>
                </div>
                <button type="submit" id="orderBtn" class="w-full md:w-auto px-10 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white rounded-xl font-bold text-lg shadow-lg transform transition hover:-translate-y-1">
                    –ü–Ü–î–¢–í–ï–†–î–ò–¢–ò –ó–ê–ú–û–í–õ–ï–ù–ù–Ø
                </button>
            </div>
            <p class="text-center text-xs text-gray-500 mt-4">–ù–∞—Ç–∏—Å–∫–∞—é—á–∏ –∫–Ω–æ–ø–∫—É, –≤–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ <a href="#" class="underline hover:text-gray-300">–ø–æ–ª—ñ—Ç–∏–∫–æ—é –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö</a>.</p>
        </div>
    </form>
</div>

<script>
    // --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ---
    const CONFIG = {
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ü–µ–Ω—Ç—Ä—É –ö—Ä–∏–≤–æ–≥–æ –†–æ–≥—É
        BASE_LOCATION: { lat: 47.9101, lng: 33.3918 }, 
        
        PRICING: {
            BASE_CALL: 200,          // –ë–∞–∑–æ–≤–∞ –ø–æ—Å–∞–¥–∫–∞
            KM_PRICE: 25,            // –¶—ñ–Ω–∞ –∑–∞ –∫–º –º–∞—Ä—à—Ä—É—Ç—É
            FEED_RETURN_KM: 25,      // –¶—ñ–Ω–∞ –∑–∞ –∫–º –ø–æ–¥–∞—á—ñ
            FLOOR_PER_PERSON: 50,    // –¶—ñ–Ω–∞ –∑–∞ –ø–æ–≤–µ—Ä—Ö –Ω–∞ –æ–¥–Ω–æ–≥–æ —Å–∞–Ω—ñ—Ç–∞—Ä–∞
            WAIT_30_MIN: 250,        // –¶—ñ–Ω–∞ –∑–∞ 30 —Ö–≤ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
            
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—Ä–∏–≥–∞–¥–∏ –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –≤–∞–≥–∏
            WEIGHT_TIERS: {
                90: { sanitars: 2, teamBaseFee: 600 },
                120: { sanitars: 3, teamBaseFee: 900 },
                130: { sanitars: 4, teamBaseFee: 1200 }
            }
        }
    };

    let map, directionsService, directionsRenderer;
    let routeDetails = { distanceKm: 0, feedKm: 0, returnKm: 0, isReady: false };

    // --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –î–ê–¢–ò ---
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('trip-date');
    const timeInput = document.getElementById('trip-time');
    
    dateInput.min = today;
    dateInput.value = today;

    // –õ–æ–≥—ñ–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞ –∑–∞—Ä–∞–∑" (+30 —Ö–≤)
    document.getElementById('nowBtn').addEventListener('click', () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        
        // –ö–æ—Ä–µ–∫—Ü—ñ—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å—É –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏
        const uaTime = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
        
        dateInput.value = uaTime.toISOString().split('T')[0];
        
        const hours = String(uaTime.getHours()).padStart(2, '0');
        const minutes = String(uaTime.getMinutes()).padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
        
        // –í—ñ–∑—É–∞–ª—å–Ω–∏–π –µ—Ñ–µ–∫—Ç –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
        const btn = document.getElementById('nowBtn');
        btn.classList.add('bg-cyan-200');
        setTimeout(() => btn.classList.remove('bg-cyan-200'), 200);
    });

    // --- GOOGLE MAPS ---
    function initMap() {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: false });
        
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 10,
            center: CONFIG.BASE_LOCATION,
            disableDefaultUI: true,
            zoomControl: true
        });
        directionsRenderer.setMap(map);

        setupAutocomplete('from');
        setupAutocomplete('to');
        
        document.getElementById('geolocateBtn').addEventListener('click', handleGeolocate);
    }

    function setupAutocomplete(elementId) {
        const input = document.getElementById(elementId);
        // –û–±–º–µ–∂–µ–Ω–Ω—è –∞–≤—Ç–æ–∫–æ–º–ø–ª—ñ—Ç—É –ø–æ –£–∫—Ä–∞—ó–Ω—ñ
        const options = {
            componentRestrictions: { country: "ua" },
            fields: ["formatted_address", "geometry", "name"],
        };
        const autocomplete = new google.maps.places.Autocomplete(input, options);
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (!place.geometry) return;
            recalculateRoute();
        });
    }

    // --- –†–û–ó–†–ê–•–£–ù–û–ö –ú–ê–†–®–†–£–¢–£ ---
    async function recalculateRoute() {
        const fromVal = document.getElementById('from').value;
        const toVal = document.getElementById('to').value;
        
        if (!fromVal || !toVal) return;

        showLoading(true);

        // –ó–±–∏—Ä–∞—î–º–æ –ø—Ä–æ–º—ñ–∂–Ω—ñ —Ç–æ—á–∫–∏ (–∑–∞—ó–∑–¥–∏)
        const waypointsInputs = document.querySelectorAll('.waypoint-input');
        const waypoints = [];
        waypointsInputs.forEach(input => {
            if(input.value.trim() !== '') waypoints.push({ location: input.value, stopover: true });
        });

        try {
            // 1. –û—Å–Ω–æ–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –∑ –ø–∞—Ü—ñ—î–Ω—Ç–æ–º
            const mainRouteResult = await directionsService.route({
                origin: fromVal,
                destination: toVal,
                waypoints: waypoints,
                optimizeWaypoints: false,
                travelMode: google.maps.TravelMode.DRIVING
            });

            directionsRenderer.setDirections(mainRouteResult);
            document.getElementById('map').classList.remove('hidden');

            let totalDistanceMeters = 0;
            mainRouteResult.routes[0].legs.forEach(leg => totalDistanceMeters += leg.distance.value);
            const distanceKm = totalDistanceMeters / 1000;

            // 2. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–æ–¥–∞—á—ñ (–ë–∞–∑–∞ -> –°—Ç–∞—Ä—Ç) —Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–§—ñ–Ω—ñ—à -> –ë–∞–∑–∞)
            const startLocation = mainRouteResult.routes[0].legs[0].start_location;
            const endLocation = mainRouteResult.routes[0].legs[mainRouteResult.routes[0].legs.length - 1].end_location;

            const [feedResult, returnResult] = await Promise.all([
                directionsService.route({
                    origin: CONFIG.BASE_LOCATION,
                    destination: startLocation,
                    travelMode: google.maps.TravelMode.DRIVING
                }),
                directionsService.route({
                    origin: endLocation,
                    destination: CONFIG.BASE_LOCATION,
                    travelMode: google.maps.TravelMode.DRIVING
                })
            ]);

            const feedKm = feedResult.routes[0].legs[0].distance.value / 1000;
            const returnKm = returnResult.routes[0].legs[0].distance.value / 1000;

            routeDetails = { distanceKm, feedKm, returnKm, isReady: true };

            document.getElementById('route-stats').innerHTML = 
                `üö© –ú–∞—Ä—à—Ä—É—Ç: ${distanceKm.toFixed(1)} –∫–º | üîÑ –ü–æ–¥–∞—á–∞+–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è: ${(feedKm + returnKm).toFixed(1)} –∫–º`;
            document.getElementById('route-stats').classList.remove('hidden');

            updatePrice();

        } catch (error) {
            console.error("Route Error:", error);
            // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ alert, –∞–ª–µ –∫—Ä–∞—â–µ –Ω–µ —Å–ø–∞–º–∏—Ç–∏ –ø–æ–º–∏–ª–∫–∞–º–∏ –ø–æ–∫–∏ –∫–ª—ñ—î–Ω—Ç –¥—Ä—É–∫—É—î
        } finally {
            showLoading(false);
        }
    }

    // --- –õ–û–ì–Ü–ö–ê –¶–Ü–ù–ò ---
    function updatePrice() {
        if (!routeDetails.isReady) return;

        let totalPrice = 0;
        const detailsList = [];

        // 1. –ú–∞—Ä—à—Ä—É—Ç
        const routeCost = (routeDetails.distanceKm * CONFIG.PRICING.KM_PRICE);
        totalPrice += routeCost + CONFIG.PRICING.BASE_CALL;
        detailsList.push(`–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É–≤–∞–Ω–Ω—è (${routeDetails.distanceKm.toFixed(1)} –∫–º): ${(routeCost + CONFIG.PRICING.BASE_CALL).toFixed(0)} –≥—Ä–Ω`);

        // 2. –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–º (–ø–æ–¥–∞—á–∞ –∞–≤—Ç–æ)
        const technicalKm = routeDetails.feedKm + routeDetails.returnKm;
        const technicalCost = technicalKm * CONFIG.PRICING.FEED_RETURN_KM;
        totalPrice += technicalCost;
        detailsList.push(`–ü–æ–¥–∞—á–∞ —Å–ø–µ—Ü—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É: ${technicalCost.toFixed(0)} –≥—Ä–Ω`);

        // 3. –ë—Ä–∏–≥–∞–¥–∞
        const weightKey = document.getElementById('weight').value;
        const weightConfig = CONFIG.PRICING.WEIGHT_TIERS[weightKey];
        const sanitarsCount = weightConfig.sanitars;
        totalPrice += weightConfig.teamBaseFee;
        detailsList.push(`–†–æ–±–æ—Ç–∞ –±—Ä–∏–≥–∞–¥–∏ (${sanitarsCount} —á–æ–ª.): ${weightConfig.teamBaseFee} –≥—Ä–Ω`);

        // 4. –ü–æ–≤–µ—Ä—Ö–∏
        let totalFloors = 0;
        
        // –ó–≤—ñ–¥–∫–∏
        const fromType = document.querySelector('input[name="fromType"]:checked').value;
        const fromElevator = document.getElementById('from-elevator').checked;
        const fromFloorVal = parseInt(document.getElementById('from-floor').value) || 1;
        if (['home', 'pansionat'].includes(fromType) && !fromElevator && fromFloorVal > 1) {
            totalFloors += (fromFloorVal - 1);
        }

        // –ö—É–¥–∏
        const toType = document.querySelector('input[name="toType"]:checked').value;
        const toElevator = document.getElementById('to-elevator').checked;
        const toFloorVal = parseInt(document.getElementById('to-floor').value) || 1;
        if (['home', 'pansionat'].includes(toType) && !toElevator && toFloorVal > 1) {
            totalFloors += (toFloorVal - 1);
        }

        if (totalFloors > 0) {
            const floorCost = totalFloors * sanitarsCount * CONFIG.PRICING.FLOOR_PER_PERSON;
            totalPrice += floorCost;
            detailsList.push(`–ü—ñ–¥–π–æ–º/–°–ø—É—Å–∫ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–∏ (${totalFloors}): ${floorCost} –≥—Ä–Ω`);
        }

        // 5. –û—á—ñ–∫—É–≤–∞–Ω–Ω—è
        const waitingMinutes = parseInt(document.getElementById('waiting').value);
        if (waitingMinutes > 0) {
            const waitCost = (waitingMinutes / 30) * CONFIG.PRICING.WAIT_30_MIN;
            totalPrice += waitCost;
            detailsList.push(`–û—á—ñ–∫—É–≤–∞–Ω–Ω—è (${waitingMinutes} —Ö–≤): ${waitCost} –≥—Ä–Ω`);
        }

        document.getElementById('total-price').innerText = Math.ceil(totalPrice);
        
        const summaryHtml = detailsList.map(item => {
            const [label, val] = item.split(':');
            return `<div class="flex justify-between border-b border-gray-700 pb-1 last:border-0 border-opacity-30">
                <span class="text-gray-400">${label}</span>
                <span class="font-bold text-cyan-400">${val}</span>
            </div>`;
        }).join('');
        document.getElementById('summary-content').innerHTML = summaryHtml;
    }

    // --- UI HELPERS ---
    const toggleFloor = (name, blockId) => {
        document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
            radio.addEventListener('change', (e) => {
                const el = document.getElementById(blockId);
                const show = ['home', 'pansionat'].includes(e.target.value);
                if (show) el.classList.remove('hidden');
                else el.classList.add('hidden');
                updatePrice();
            });
        });
    };
    toggleFloor('fromType', 'from-floor-opts');
    toggleFloor('toType', 'to-floor-opts');

    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤ –ø–æ–≤–µ—Ä—Ö—ñ–≤
    const floorSelects = ['from-floor', 'to-floor'];
    floorSelects.forEach(id => {
        const sel = document.getElementById(id);
        for(let i=1; i<=16; i++) sel.innerHTML += `<option value="${i}">${i}</option>`;
    });

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø—Ä–æ–º—ñ–∂–Ω–∏—Ö —Ç–æ—á–æ–∫
    document.getElementById('addWaypointBtn').addEventListener('click', () => {
        const container = document.getElementById('waypoints-list');
        const id = 'waypoint-' + Date.now();
        const div = document.createElement('div');
        div.className = 'relative flex items-center mb-2';
        div.innerHTML = `
            <div class="step-circle" style="width:24px; height:24px; font-size:12px; margin-right:8px; background:#e2e8f0; color:#4a5568">+</div>
            <input type="text" id="${id}" class="waypoint-input w-full p-3 border-2 border-gray-200 rounded-lg focus:border-cyan-500 outline-none text-sm" placeholder="–ê–¥—Ä–µ—Å–∞ –∑–∞—ó–∑–¥—É">
            <button type="button" class="ml-2 text-red-400 hover:text-red-600 font-bold px-2" onclick="this.parentElement.remove(); recalculateRoute();">‚úï</button>
        `;
        container.appendChild(div);
        setupAutocomplete(id);
    });

    function handleGeolocate() {
        if (navigator.geolocation) {
            showLoading(true);
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: { lat: position.coords.latitude, lng: position.coords.longitude } })
                        .then((response) => {
                            if (response.results[0]) {
                                document.getElementById('from').value = response.results[0].formatted_address;
                                recalculateRoute();
                            }
                        })
                        .finally(() => showLoading(false));
                },
                () => { showLoading(false); alert("–î–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ."); }
            );
        }
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('hidden', !show);
    }

    // –°–ª—É—Ö–∞—á—ñ –∑–º—ñ–Ω –¥–ª—è –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω–∏
    ['weight', 'waiting', 'from-floor', 'to-floor', 'from-elevator', 'to-elevator'].forEach(id => {
        document.getElementById(id).addEventListener('change', updatePrice);
    });

    // –§—ñ–Ω–∞–ª—å–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    document.getElementById('calcForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        if(!routeDetails.isReady || document.getElementById('total-price').innerText == '0') {
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç.");
            return;
        }
        
        const phone = document.getElementById('phone').value;
        if(phone.length < 10) { alert("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω"); return; }

        const order = {
            from: document.getElementById('from').value,
            to: document.getElementById('to').value,
            date: document.getElementById('trip-date').value,
            time: document.getElementById('trip-time').value,
            phone: phone,
            name: document.getElementById('name').value,
            price: document.getElementById('total-price').innerText,
            diagnosis: document.getElementById('diagnosis').value
        };
        
        // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –¥–∞–Ω–∏—Ö –≤ Telegram –∞–±–æ CRM
        alert(`–î—è–∫—É—î–º–æ, ${order.name}!\n–ë—Ä–∏–≥–∞–¥–∞ –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω–∞ –Ω–∞ ${order.date} ${order.time}.\n–°—É–º–∞: ${order.price} –≥—Ä–Ω.\n–ú–∏ –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—î–º–æ –Ω–∞ ${order.phone} –ø—Ä–æ—Ç—è–≥–æ–º 5 —Ö–≤–∏–ª–∏–Ω.`);
    });
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSavrlyG9355c5lIDSaAZDIDEiK4WmAh4&libraries=places&callback=initMap&language=uk" async defer></script>
</body>
</html>